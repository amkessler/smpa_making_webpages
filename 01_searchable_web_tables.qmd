---
title: "Making a searchable database table"
author: "Aaron Kessler"
format:
  html:
    self-contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(DT)

#### PRESIDENTIAL CANDIDATE TRIPS ####
   
# Load in data of prez candidate campaign trips between midterms and end of Jan
events <- readRDS("events_saved.rds")


```

## Using DT to make a searchable table

```{r}
#### MAKING A SEARCHABLE TABLE FOR THE WEB ####

# First -- let's talk about: what is the Internet? What IS a web page?
# An oldie but a goodie from 2009: https://www.youtube.com/watch?v=7_LPdttKXPc
# Bottom line, it's just a bunch of computers connected to each other. 
# A website? It's just files on someone else's computer (aka server)
```


```{r}
#We can use the "DT" package to easily make a sortable, filterable, searchable data table
#Just this little bit of code does a whole lot - check it out:

DT::datatable(events)

```


```{r}
#We can already sort, but what if we want to allow the table to be FILTERED too?
#It's easy, we just add:
DT::datatable(events, 
              rownames = FALSE, 
              filter = "top"  # <--- NEW STUFF HERE
              )
```


```{r}
#Now hmm, what's up with the filters on the text columns? Why aren't they working?
#It's because of a quirk in DT tables where filters will only work on text that is converted to a factor
#So let's do that
events <- events %>% 
  mutate(
    state = as_factor(state),
    event_type = as_factor(event_type)
  )
```


```{r}
#Now let's try the DT table code again and see if it worked
DT::datatable(events, 
              rownames = FALSE, 
              filter = "top")
```


```{r}
#Now, for the coup de gr?ce
#let's add some buttons at the top of the page to let people copy, download, etc
#we do that using a DT "extenstion" called, you guessed it, Buttons
# https://rstudio.github.io/DT/extensions.html

DT::datatable(events, 
              rownames = FALSE, 
              filter = "top", 
              extensions = 'Buttons', 
              options = list(   # <--- NEW STUFF STARTS HERE
                dom = 'Bfrtip',
                buttons = c('copy', 'pdf', "excel")
              )) %>%
  DT::formatStyle('cand_lastname',  color = '#a65ed6', fontWeight = 'bold')
```


```{r}
## saving the result

# first we just need to assign our table to a variable...

mytable <- DT::datatable(events, 
                         rownames = FALSE, 
                         filter = "top", 
                         extensions = 'Buttons', 
                         options = list(
                           dom = 'Bfrtip',
                           buttons = c('copy', 'csv', "excel")
                         )) %>%
  DT::formatStyle('cand_lastname',  color = 'red', fontWeight = 'bold') 

# ... then just run this simple bit of code to export to html
htmlwidgets::saveWidget(mytable, "candidatetracker.html")


# We've now created a working web page that can be put anywhere on the internet we choose
# Yay!

# If we stay within the world of quarto though we don't need to export it, we can just display it
# within the quarto page of course
```


### Creating a Minimal Table

What if we have a little table and want a super minimal table with everything stripped out
```{r}

events %>% 
  head(5) %>% 
  DT::datatable(rownames = FALSE, 
                options = list(searching = FALSE, paging = FALSE, dom = "tip")) 


```

## Advanced DT Formatting and Conditional Styling

Sometimes you want to highlight specific data points or format columns differently to make your table more readable and visually appealing.

```{r}
# Create a table with conditional formatting based on data values
# This example highlights different candidate parties with colors
# and formats the date column for better readability

DT::datatable(events, 
              rownames = FALSE, 
              filter = "top",
              extensions = 'Buttons', 
              options = list(
                dom = 'Bfrtip',
                buttons = c('copy', 'csv', 'excel'),
                pageLength = 15,
                scrollX = TRUE
              )) %>%
  # Format the date column to be more readable
  DT::formatDate('date', method = 'toLocaleDateString') %>%
  # Highlight Democratic candidates in blue
  DT::formatStyle('cand_lastname', 
                  backgroundColor = DT::styleEqual('Biden', '#E3F2FD')) %>%
  DT::formatStyle('cand_lastname', 
                  backgroundColor = DT::styleEqual('Warren', '#E3F2FD')) %>%
  # Highlight Republican candidates in red
  DT::formatStyle('cand_lastname', 
                  backgroundColor = DT::styleEqual('Trump', '#FFEBEE')) %>%
  # Make the event type column bold and change text color
  DT::formatStyle('event_type', fontWeight = 'bold', color = '#2E7D32')

```

## Customizing Search and Display Options

For more advanced users, you can customize how the search functionality works and control the table's appearance more precisely.

```{r}
# Create a more customized table with specific search options
# and enhanced user experience features

DT::datatable(events, 
              rownames = FALSE, 
              filter = list(position = 'top', clear = FALSE),
              extensions = c('Buttons', 'ColReorder'), 
              options = list(
                dom = 'Blfrtip',  # B=buttons, l=length menu, f=filtering, r=processing, t=table, i=info, p=pagination
                buttons = list(
                  'copy',
                  list(extend = 'csv', filename = 'campaign_events'),
                  list(extend = 'excel', filename = 'campaign_events'),
                  'colvis'  # Column visibility toggle
                ),
                pageLength = 10,
                lengthMenu = list(c(5, 10, 25, 50, -1), c('5', '10', '25', '50', 'All')),
                scrollX = TRUE,
                colReorder = TRUE,  # Allow column reordering
                search = list(regex = TRUE, caseInsensitive = TRUE),
                columnDefs = list(
                  list(targets = '_all', className = 'dt-center'),  # Center align all columns
                  list(targets = c(0), visible = FALSE),  # Hide first column if needed
                  list(targets = c(1, 2), searchable = TRUE)  # Make specific columns searchable
                )
              )) %>%
  # Add custom styling for better readability
  DT::formatStyle(columns = c('cand_lastname'), 
                  fontSize = '14px', 
                  fontWeight = 'bold') %>%
  DT::formatStyle(columns = c('state'), 
                  backgroundColor = '#F5F5F5',
                  border = '1px solid #ddd')

```

